group: vm
jdk: openjdk11
language: android

android:
  components:
    - android-29
    - build-tools-29.0.3

env:
  global:
    # GH_TOKEN
    - secure: "n7blhZYs6/0J+1q/MP0U9aOTuWUxLDwg+O08km4H1dVIMMCx0POTyNW7kLQ1m0oAcBateMFStRpuBAObR5h6SgWDC50SbKYjWaeZrqrA0EKpd5yAsXSbg6y5F8jobogd2kfyHJtgdPU5laysfw0jVOl8Vt3WwXP0JnfNT2fzSSv6B/scDnkFj0XjuOLRMW508L8JYY6d9J3kXXvOIt14M0hGUGbC+h7zFArRgwfXnPjNZ1cWrXXqjOe9fjHkwRGJ3QnwQxsiM6M3JTLtGk3SSyJMyNI7CTGH9M5jpZzcd3TkRkS26Evx8dnUENH5giB9cFpSgnRR5dW/UykxMlamlgEIdMgKepjWRbWR8uks1FP9pl1Q6Bw8dBMUr8baWq41Z65cD8ucyNhcUfsGIaJoPxKVBF0gke8NWNlbOW7Auo1mBxpxRJ2X/U3N0zniij7zz4MFdo1fTHb1jY7G9UFchWDnT9Moi97mv5+vzL+R1R0EIsUE9DrrjPeaC/lNTFp4kVUdUbZT91kce1CP2XQfQ8WGfwI0V8E1mzj8/0VoXyKj7XZIf7x3mZALSPNyYWc8pzIScsrPBB0ZTLKeWY3iKGTzzWz4lZ9e9P8FBsStxCV8tiQkJLd9hgNtvReVFBpSGMXZnzlI3quW38YaX0m8IgendFs9gmeYKiTmZJMUgSs="
    - ORG_GRADLE_PROJECT_sonatypeUsername=samuelg
    # Encrypted ORG_GRADLE_PROJECT_sonatypePassword
    # - secure: 
    # Encrypted SIGNING_PASSWORD (encrypted SIGNING_KEY, Base64 encoded, is set in Travis environment variables)
    # - secure: 

script: ./gradlew build testRelease connectedCheck --exclude-task testDebugUnitTest

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/

before_deploy:
  - >
    if ! [ "$BEFORE_DEPLOY_RUN" ]; then
      export BEFORE_DEPLOY_RUN=1
      ./gradlew dokkaHtml
      mkdir docs
      cp -r webflows/build/dokka/html/. docs/.
    fi

deploy:
  - provider: pages
    skip_cleanup: true
    github_token: $GH_TOKEN
    verbose: true
    local_dir: docs
    on:
      repo: schibsted/account-sdk-android-web
      branch: master

  - provider: script
    skip_cleanup: true
    script: ./gradlew publishToSonatype closeAndReleaseSonatypeStagingRepository
    on:
      repo: schibsted/account-sdk-android-web
      tags: true
